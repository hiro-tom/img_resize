# SFTP画像圧縮処理システム プログラム仕様書

## 1. システム概要

### 1.1 システム名
SFTP画像圧縮処理システム

### 1.2 目的
SFTPサーバーから画像ファイルを取得し、指定されたサイズ・品質に圧縮処理を行い、処理済み画像を別のSFTPディレクトリにアップロードするWebベースの画像処理システム。

### 1.3 システム構成
- **バックエンド**: Python 3.11+ / FastAPI
- **フロントエンド**: HTML/CSS/JavaScript (SPA)
- **データベース**: SQLite
- **実行環境**: ローカル / AWS EC2

---

## 2. 機能一覧

| No | 機能名 | 説明 |
|----|--------|------|
| 1 | ユーザー認証 | セッションベースのログイン/ログアウト機能 |
| 2 | SFTP取込 | リモートSFTPサーバーからローカルへのファイル同期 |
| 3 | 画像圧縮 | 画像のリサイズ・品質圧縮処理 |
| 4 | SFTPアップロード | 圧縮済み画像のリモートサーバーへのアップロード |
| 5 | 設定管理 | 接続情報・処理パラメータの設定・保存 |
| 6 | ログ管理 | 処理ログの表示・クリア |
| 7 | ユーザー管理 | ログイン認証情報の管理 |

---

## 3. ファイル構成

```
img_resize/
├── backend/
│   ├── main.py              # FastAPIアプリケーション本体
│   ├── db.py                 # データベース操作モジュール
│   ├── schemas.py            # Pydanticスキーマ定義
│   ├── sftp_sync.py          # SFTP取込処理モジュール
│   ├── sftp_upload.py        # SFTPアップロード処理モジュール
│   ├── image_compress.py     # 画像圧縮処理モジュール
│   ├── requirements.txt      # Python依存パッケージ
│   └── data/
│       └── app.db            # SQLiteデータベース
├── docs/
│   └── SPECIFICATION.md      # 本仕様書
├── deploy.sh                 # デプロイスクリプト
└── DEPLOYMENT.md             # デプロイ手順書
```

---

## 4. データベース設計

### 4.1 テーブル一覧

| テーブル名 | 説明 |
|-----------|------|
| settings | アプリケーション設定 |
| logs | 処理ログ |
| users | ユーザー認証情報 |

### 4.2 settingsテーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー (固定値: 1) |
| data | TEXT | JSON形式の設定データ |

### 4.3 logsテーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー (自動採番) |
| created_at | TEXT | 作成日時 (JST) |
| level | TEXT | ログレベル (INFO/WARN/ERROR) |
| message | TEXT | ログメッセージ |
| detail | TEXT | 詳細情報 (NULL可) |

### 4.4 usersテーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー (固定値: 1) |
| username | TEXT | ユーザー名 |
| password | TEXT | 暗号化パスワード |

---

## 5. 設定項目

### 5.1 SFTP接続設定

| 項目名 | フィールド名 | 型 | デフォルト | 説明 |
|--------|-------------|-----|-----------|------|
| 接続先ドメイン | host | string | - | SFTPサーバーのホスト名/IP |
| ポート | port | integer | 22 | SFTPポート番号 |
| ユーザー名 | username | string | - | SFTP認証ユーザー名 |
| パスワード | password | string | null | SFTP認証パスワード |
| 秘密鍵パス | private_key_path | string | null | 秘密鍵ファイルのパス |

### 5.2 ディレクトリ設定

| 項目名 | フィールド名 | 型 | 説明 |
|--------|-------------|-----|------|
| 接続先フォルダー | remote_dir | string | SFTP取込元ディレクトリ |
| ローカルフォルダー | local_dir | string | ローカル保存先ディレクトリ |
| 画像圧縮出力先フォルダー | compress_output_dir | string | 圧縮処理後の出力先 |
| 接続先出力フォルダー | remote_output_dir | string | SFTPアップロード先ディレクトリ |

### 5.3 画像処理設定

| 項目名 | フィールド名 | 型 | デフォルト | 範囲 | 説明 |
|--------|-------------|-----|-----------|------|------|
| 画像圧縮率 | compress_quality | integer | 85 | 1-100 | JPEG圧縮品質 |
| 横dpi | resize_width_dpi | integer | null | - | リサイズ後の横幅(px) |
| 縦dpi | resize_height_dpi | integer | null | - | リサイズ後の縦幅(px) |

### 5.4 監視間隔設定

| 項目名 | フィールド名 | 型 | デフォルト | 説明 |
|--------|-------------|-----|-----------|------|
| SFTP取込間隔 | sync_interval_seconds | integer | 5 | 0=1回のみ実行 |
| 画像圧縮間隔 | compress_interval_seconds | integer | 10 | 0=1回のみ実行 |
| SFTPアップロード間隔 | upload_interval_seconds | integer | 10 | 0=1回のみ実行 |

---

## 6. API仕様

### 6.1 認証API

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | /auth/login | ログイン |
| POST | /auth/logout | ログアウト |
| GET | /auth/me | 認証状態確認 |

### 6.2 設定API

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /settings | 設定取得 |
| POST | /settings | 設定保存 |
| POST | /settings/test | 接続テスト |

### 6.3 SFTP取込API

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | /sync/run | SFTP取込開始 |
| POST | /sync/stop | SFTP取込停止 |
| GET | /sync/status | SFTP取込状態取得 |

### 6.4 画像圧縮API

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | /compress/run | 画像圧縮開始 |
| POST | /compress/stop | 画像圧縮停止 |
| GET | /compress/status | 画像圧縮状態取得 |

### 6.5 SFTPアップロードAPI

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | /upload/run | SFTPアップロード開始 |
| POST | /upload/stop | SFTPアップロード停止 |
| GET | /upload/status | SFTPアップロード状態取得 |

### 6.6 ログAPI

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /logs | ログ一覧取得 (最新200件) |
| DELETE | /logs | ログ全削除 |

### 6.7 ユーザー管理API

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /user | ユーザー情報取得 |
| POST | /user | ユーザー情報保存 |

---

## 7. 処理フロー

### 7.1 全体処理フロー

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  SFTP取込処理   │ →  │  画像圧縮処理   │ →  │ SFTPアップロード│
│                 │    │                 │    │      処理       │
│ remote_dir      │    │ local_dir       │    │compress_output  │
│    ↓            │    │    ↓            │    │   _dir          │
│ local_dir       │    │compress_output  │    │    ↓            │
│                 │    │   _dir          │    │remote_output_dir│
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 7.2 SFTP取込処理

1. SFTPサーバーに接続
2. リモートディレクトリのファイル一覧を取得
3. ローカルファイルと比較し、差分を検出
4. 新規/更新ファイルをダウンロード
5. ファイルのタイムスタンプを保持
6. 接続をクローズ

### 7.3 画像圧縮処理

1. 入力ディレクトリの画像ファイルを走査
2. 対象ファイル形式: JPG, JPEG, PNG, WebP, BMP, TIFF
3. リサイズ処理 (設定がある場合)
   - LANCZOS法によるリサイズ
4. RGB変換 (透過画像は白背景)
5. JPEG形式で出力 (指定品質)
6. 出力ディレクトリに保存

### 7.4 SFTPアップロード処理

1. SFTPサーバーに接続
2. 圧縮出力ディレクトリのファイルを走査
3. リモートディレクトリにアップロード
4. ファイルのタイムスタンプを設定
5. **アップロード後のローカルファイル削除: 無効**
6. 接続をクローズ

---

## 8. セキュリティ

### 8.1 認証方式

- セッションベース認証
- HTTP-only Cookie使用
- HMAC-SHA256によるトークン署名
- セッション有効期限: 12時間

### 8.2 パスワード暗号化

- Fernet暗号化 (AES-128-CBC)
- 暗号化キー: SESSION_SECRETからSHA256派生

### 8.3 環境変数

| 変数名 | デフォルト | 説明 |
|--------|-----------|------|
| APP_USER | admin | 初期ユーザー名 |
| APP_PASSWORD | password | 初期パスワード |
| SESSION_SECRET | change-me | セッション署名キー |

---

## 9. 依存パッケージ

| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| fastapi | 0.115.5 | Webフレームワーク |
| uvicorn | 0.30.1 | ASGIサーバー |
| paramiko | 3.4.0 | SFTP/SSH接続 |
| pydantic | 2.9.2 | データバリデーション |
| Pillow | >=10.0.0 | 画像処理 |
| cryptography | - | パスワード暗号化 |

---

## 10. デプロイ

### 10.1 ローカル実行

```bash
cd backend
python -m venv .venv
.venv\Scripts\activate  # Windows
pip install -r requirements.txt
uvicorn main:app --host 127.0.0.1 --port 8000
```

### 10.2 AWS EC2デプロイ

- インスタンスタイプ: t2.micro
- AMI: Ubuntu 22.04 LTS
- セキュリティグループ: ポート22, 8000開放
- systemdサービスとして自動起動

---

## 11. ログ出力

### 11.1 ログレベル

| レベル | 用途 |
|--------|------|
| INFO | 正常処理情報 |
| WARN | 警告 (処理継続可能) |
| ERROR | エラー (処理失敗) |

### 11.2 主要ログメッセージ

| 処理 | メッセージ例 |
|------|-------------|
| SFTP接続 | [SFTP実行] 接続成功: host:port |
| ファイルコピー | [コピー完了] filename.jpg (1.5 MB) |
| 画像圧縮 | 圧縮完了: filename.jpg (500KB → 120KB, 削減: 380KB) |
| アップロード | [アップロード完了] filename.jpg |

---

## 12. 制限事項

1. 同時実行制御: 各処理(取込/圧縮/アップロード)は排他制御
2. ユーザー: シングルユーザーシステム (id=1固定)
3. 対応画像形式: JPG, JPEG, PNG, WebP, BMP, TIFF
4. 出力形式: JPEG固定

---

## 13. 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2026-01-29 | 1.0.0 | 初版作成 |
| 2026-01-29 | 1.1.0 | 画像リサイズ機能追加 (横dpi×縦dpi) |
| 2026-01-29 | 1.2.0 | SFTPアップロード後のファイル削除無効化 |

---

## 14. 問い合わせ先

- GitHub: https://github.com/hiro-tom/img_resize
