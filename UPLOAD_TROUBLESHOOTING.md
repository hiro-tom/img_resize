# SFTP アップロード機能 - トラブルシューティングガイド

## 問題: 接続先出力フォルダー (remote_output_dir) にファイルがSFTP転送されない

### 原因の特定手順

#### 1. 設定の確認
Web UI の「設定」ページで以下の項目が正しく入力されているか確認してください：

- **接続先出力フォルダー (remote_output_dir)**: 空になっていないか
- **画像圧縮出力先フォルダー (compress_output_dir)**: 有効なローカルパスか
- **SFTP接続情報**: ホスト、ポート、ユーザー名、パスワード/秘密鍵が正しいか

#### 2. 接続テストを実行
Web UI で「接続テスト」ボタンをクリックして、SFTP接続が正常か確認します。

#### 3. ログを確認
Web UI の「ログ」ページで、アップロード実行時のログを確認します。

以下のログメッセージを探してください：

**正常な場合**:
```
[INFO] SFTPアップロード監視開始: ユーザーによる監視開始要求
[INFO] アップロード対象フォルダーに X 個のファイルがあります: ...
[INFO] SFTPアップロード開始: ... → ...
[INFO] SFTP接続成功: ...
[INFO] [アップロード開始] ファイル名 (サイズ)
[INFO] [アップロード完了] ファイル名
[INFO] SFTPアップロード監視終了: アップロード=X件 ...
```

### よくある問題と解決策

#### 問題 1: 「接続先出力フォルダー(remote_output_dir)が未設定です」というエラー

**原因**: `remote_output_dir` が設定されていない

**解決策**:
1. Web UI で「設定」ページを開く
2. 「接続先出力フォルダー (remote_output_dir)」フィールドに値を入力（例: `/output`)
3. 「設定保存」ボタンをクリック
4. 「アップロード実行」ボタンをクリック

#### 問題 2: 「アップロード対象フォルダーが存在しません」というエラー

**原因**: `compress_output_dir` が設定されていないか、フォルダーが存在しない

**解決策**:
1. Web UI で「設定」ページを開く
2. 「画像圧縮出力先フォルダー (compress_output_dir)」が有効なパスか確認
3. 必要に応じて、フォルダーを事前に作成
4. 「設定保存」ボタンをクリック
5. 「アップロード実行」ボタンをクリック

#### 問題 3: 「アップロード対象のファイルがありません」というメッセージ

**原因**: `compress_output_dir` にファイルが存在しない

**解決策**:
1. 画像圧縮処理を実行して、`compress_output_dir` にファイルを生成する
2. 「設定」ページで `compress_output_dir` を確認
3. ローカルマシンでフォルダーを直接確認して、ファイルが存在するか確認
4. その後、「アップロード実行」ボタンをクリック

#### 問題 4: SFTP接続エラー

**ログ例**:
```
[ERROR] SFTP接続エラー: ...
```

**原因**: SFTP接続が失敗している可能性があります

**解決策**:
1. Web UI で「接続テスト」を実行して、接続情報が正しいか確認
2. SFTP サーバーのホスト、ポート、ユーザー名、パスワード/秘密鍵を再確認
3. ネットワーク接続を確認（ファイアウォール、ルーターの設定など）
4. SFTP サーバーが稼働しているか確認

#### 問題 5: ファイルはアップロードされたがリモートフォルダーに見えない

**原因**: `remote_output_dir` のパスが正しくないか、リモートサーバーの権限が不足

**解決策**:
1. Web UI で「接続テスト」を実行
2. `remote_output_dir` のパスを確認（SFTP サーバー上での正確なパス）
3. SFTP クライアント（例: WinSCP、Cyberduck）を使用して直接確認
4. リモートサーバーの権限設定を確認

### デバッグ情報の取得

サーバーコンソール出力を確認する方法：

```bash
# Windows PowerShell
# ターミナルで以下のコマンドを実行
cd c:\workspace\img_resize\backend
C:/workspace/img_resize/.venv/Scripts/python.exe -m uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

サーバーログに以下のような詳細情報が出力されます：

```
[DEBUG] アップロード処理: local_dir=..., remote_dir=...
[DEBUG] ローカルディレクトリ存在確認: True/False
[DEBUG] アップロード対象ファイル検出: ファイル名
```

### 設定値の確認方法

Web UI から以下の診断エンドポイントにアクセスして、現在の設定と状態を確認することができます（開発用）：

```
GET /upload/diagnose
```

このエンドポイントは以下の情報を返します：
- `compress_output_dir`: 圧縮フォルダーのパス
- `compress_dir_exists`: フォルダーの存在確認
- `compress_files_count`: フォルダー内のファイル数
- `compress_dir_contents`: ファイルの一覧（最大10個）
- `remote_output_dir`: リモートフォルダーのパス
- `remote_output_dir_is_set`: 設定の有無
- `upload_interval_seconds`: アップロード間隔
- `upload_running`: 実行中フラグ

### その他の注意事項

1. **ファイルの自動削除**: アップロード後、`compress_output_dir` のファイルは自動的に削除されます。削除を防ぐには、コード内の `delete_after_upload` パラメータを `False` に変更する必要があります。

2. **アップロード間隔**: 
   - `upload_interval_seconds` = 0: 1回のみ実行
   - `upload_interval_seconds` > 0: 指定秒数ごとに監視して自動アップロード

3. **ローカルリソース**: アップロード機能は別スレッドで実行されるため、メインアプリケーションをブロックしません。

### さらにサポートが必要な場合

サーバーログファイルを確認し、エラーメッセージの詳細情報を確認してください。
